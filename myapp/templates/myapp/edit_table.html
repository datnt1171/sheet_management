{% load static %}

<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Edit Table</title>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@12.3.1/dist/handsontable.full.min.css">
        <script src="https://cdn.jsdelivr.net/npm/handsontable@12.3.1/dist/handsontable.full.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.4/xlsx.full.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
        
        <link rel="stylesheet" href="{% static 'hot.css' %}">
        <link rel="stylesheet" href="{% static 'table_header.css' %}">
        <link rel="stylesheet" href="{% static 'footer_image.css' %}">
    </head>
    <body>
        {% include 'myapp/table_header.html' %}
        
        <div id="hot"></div>

        <button class="no-print" onclick="mergeCells()">Merge Cells</button>
        <button class="no-print" onclick="saveTable()">Save Table</button>
        <button class="no-print" onclick="saveTableWithTempName()">Save Table with Temp Name</button>
        <button class="no-print" onclick="exportToExcel()">Export to Excel</button>
        <button class="no-print" onclick="printTable()">Print Table</button>
        <button class="no-print" onclick="toggleRowIndex()">Toggle</button>
        <button class="no-print" onclick="appendFooterRow()">Append Footer Row</button>

        {% include 'myapp/footer_image.html' %}

        <script>
            // Dictionary containing product details
            let hot; // Declare it globally

            async function loadProductData() {
                const response = await fetch('/static/steps.json');
                const productData = await response.json();
                initHandsontable(productData);  // Only initialize Handsontable when data is ready
            }

            function initHandsontable(productData) {
                const WidthUnit = 38 / 4.11;
                const container = document.getElementById('hot');
                hot = new Handsontable(container, {  // Assign to the global variable
                    data: JSON.parse('{{ table_data_json|escapejs }}'),
                    contextMenu: true,
                    minRows: 20,
                    rowHeights: true,
                    height: 'auto',
                    manualRowResize: true,
                    colHeaders: [ "Step", "Step Name", "Viscosity & Wet Mill Thickness (EN)", "Viscosity & Wet Mill Thickness (VN)", 
                                "SPEC EN", "SPEC VN", "Hold Time (min)", "Chemical Mixing Code", "Consumption (per m2)", 
                                "Material Code","Material Name", "Ratio", "Qty (per m2)", "Unit", 
                                "Check Result", "Correct Action", "TE-1's Sign", "Customer's Sign" ],
                    colWidths: [WidthUnit * 4.11, WidthUnit * 6.89, WidthUnit * 13, WidthUnit * 13, WidthUnit * 13, WidthUnit * 13, 
                                WidthUnit * 5, WidthUnit * 8.78, WidthUnit * 9.5, WidthUnit * 10.22, WidthUnit * 11.67, 
                                WidthUnit * 4.89, WidthUnit * 4.89, WidthUnit * 4.89, WidthUnit * 12, WidthUnit * 12, 
                                WidthUnit * 6.56, WidthUnit * 8.56],
                    columns: [
                        { type: 'text' }, 
                        { type: 'dropdown', source: Object.keys(productData), allowEmpty: false }, 
                        { type: 'text'}, { type: 'text'}, { type: 'text'}, { type: 'text'}, 
                        { type: 'numeric'}, { type: 'text'}, { type: 'numeric'}, { type: 'text' }, 
                        { type: 'text' }, { type: 'numeric' }, { type: 'numeric' }, { type: 'text' }, 
                        { type: 'text' }, { type: 'text' }, { type: 'text' }, { type: 'text' }  
                    ],
                    mergeCells: [], 
                    licenseKey: 'non-commercial-and-evaluation',
                });

                hot.addHook('afterChange', function(changes) {
                if (!changes) return;

                changes.forEach(([row, prop, oldVal, newVal]) => {
                    if (prop === 1 && productData[newVal]) { // Step Name changed
                        const product = productData[newVal];
                        hot.setDataAtRowProp(row, 2, product.viscosity_en);
                        hot.setDataAtRowProp(row, 3, product.viscosity_vn);
                        hot.setDataAtRowProp(row, 4, product.SPEC_EN);
                        hot.setDataAtRowProp(row, 5, product.SPEC_VN);
                        hot.setDataAtRowProp(row, 6, product.hold_time);
                        hot.setDataAtRowProp(row, 8, product.consumption);
                    }
                });
            });
            }

            // Call the function to fetch data and initialize Handsontable
            loadProductData();
            function saveTable() {
                const tableData = hot.getData();
                fetch(`/api/save/{{ table.id }}/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify(tableData)
                })
                .then(response => response.json())
                .then(data => alert(data.message || data.error));
            }

            function saveTableWithTempName() {
                const tableData = hot.getData();
                
                fetch(`/api/save-with-temp-name/{{ table.id }}/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify(tableData)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Table saved with temp name successfully!');
                        window.location.href = `/edit/${data.new_table_id}/`;
                    } else {
                        alert(data.error || 'Failed to save table with temp name.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while saving the table.');
                });
            }

            function appendFooterRow() {
                const newRowIndex = hot.countRows(); // Get index for the new row
                hot.alter('insert_row', newRowIndex); // Insert a new row

                // Set text for merged cells
                hot.setDataAtRowProp(newRowIndex, 0, "PREPARED BY : FINISHING SPECIALIST");
                hot.setDataAtRowProp(newRowIndex, 4, "APPROVED BY: PAINT SUPPLIER");
                hot.setDataAtRowProp(newRowIndex, 14, "APPROVED BY: FINISHING MANAGER");

                // Merge cells
                hot.updateSettings({
                    mergeCells: [
                        { row: newRowIndex, col: 0, rowspan: 1, colspan: 4 },  // Merge col 0-3
                        { row: newRowIndex, col: 4, rowspan: 1, colspan: 10 }, // Merge col 4-13
                        { row: newRowIndex, col: 14, rowspan: 1, colspan: 4 }  // Merge col 14-17
                    ]
                });

                // Apply class for styling
                for (let col = 0; col < 18; col++) {
                    hot.setCellMeta(newRowIndex, col, 'className', 'htLastRow');
                }

                // Set row height
                let rowHeights = hot.getSettings().rowHeights || []; // Get current row heights
                rowHeights[newRowIndex] = 50; // Set fixed height (Adjust as needed)
                hot.updateSettings({ rowHeights: rowHeights });

                hot.render(); // Re-render the table
            }

        </script>
    <!-- JavaScript -->
    <script src="{% static 'hot_table.js' %}"></script>
    </body>
</html>
