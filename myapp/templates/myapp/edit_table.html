{% load static %}

<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Edit Table</title>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@12.3.1/dist/handsontable.full.min.css">
        <script src="https://cdn.jsdelivr.net/npm/handsontable@12.3.1/dist/handsontable.full.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.4/xlsx.full.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/dom-to-image-more"></script>
        
        <link rel="stylesheet" href="{% static 'hot.css' %}">
        <link rel="stylesheet" href="{% static 'table_header.css' %}">
        <link rel="stylesheet" href="{% static 'footer_image.css' %}">
    </head>
    <body>
        <div id="print">
            {% include 'myapp/table_header.html' %}
            <div id="hot"></div>
        </div>
        
        
        

        <button class="no-print" onclick="mergeCells()">Merge Cells</button>
        <button class="no-print" onclick="saveTable()">Save Table</button>
        <button class="no-print" onclick="saveTableWithTempName()">Save Table with Temp Name</button>
        <button class="no-print" onclick="exportToExcel()">Export to Excel</button>
        <button class="no-print" onclick="captureTable()">Print</button>
        <button class="no-print" onclick="toggleRowIndex()">Toggle</button>
        <button class="no-print" onclick="appendFooterRow()">Append Footer Row</button>
        <button id="capture-btn">Capture Handsontable</button>

        {% include 'myapp/footer_image.html' %}
















        <script>
            // Dictionary containing product details
            let hot; // Declare it globally

            async function loadProductData() {
                const response = await fetch('/static/steps.json');
                const productData = await response.json();
                initHandsontable(productData);  // Only initialize Handsontable when data is ready
            }

            function initHandsontable(productData) {
                const WidthUnit = 38 / 4.11;
                const container = document.getElementById('hot');
                hot = new Handsontable(container, {  // Assign to the global variable
                    data: JSON.parse('{{ table_data_json|escapejs }}'),
                    contextMenu: true,
                    minRows: 20,
                    rowHeights: true,
                    height: 'auto',
                    manualRowResize: true,
                    colHeaders: [ "Step", "Step Name", "Viscosity & Wet Mill Thickness (EN)", "Viscosity & Wet Mill Thickness (VN)", 
                                "SPEC EN", "SPEC VN", "Hold Time (min)", "Chemical Mixing Code", "Consumption (per m2)", 
                                "Material Code","Material Name", "Ratio", "Qty (per m2)", "Unit", 
                                "Check Result", "Correct Action", "TE-1's Sign", "Customer's Sign" ],
                    colWidths: [WidthUnit * 4.2, WidthUnit * 6.89, WidthUnit * 13, WidthUnit * 13, WidthUnit * 13, WidthUnit * 13, 
                                WidthUnit * 5, WidthUnit * 8.78, WidthUnit * 9.5, WidthUnit * 10.22, WidthUnit * 11.67, 
                                WidthUnit * 4.89, WidthUnit * 4.89, WidthUnit * 4.89, WidthUnit * 12, WidthUnit * 12, 
                                WidthUnit * 6.56, WidthUnit * 8.56],
                    columns: [
                        { type: 'text' }, 
                        { type: 'dropdown', source: Object.keys(productData), allowEmpty: false }, 
                        { type: 'text'}, { type: 'text'}, { type: 'text'}, { type: 'text'}, 
                        { type: 'numeric'}, { type: 'text'}, { type: 'numeric'}, { type: 'text' }, 
                        { type: 'text' }, { type: 'numeric' }, { type: 'numeric' }, { type: 'text' }, 
                        { type: 'text' }, { type: 'text' }, { type: 'text' }, { type: 'text' }  
                    ],
                    mergeCells: [], 
                    licenseKey: 'non-commercial-and-evaluation',
                });

                hot.addHook('afterChange', function(changes) {
                if (!changes) return;

                changes.forEach(([row, prop, oldVal, newVal]) => {
                    if (prop === 1 && productData[newVal]) { // Step Name changed
                        const product = productData[newVal];
                        hot.setDataAtRowProp(row, 2, product.viscosity_en);
                        hot.setDataAtRowProp(row, 3, product.viscosity_vn);
                        hot.setDataAtRowProp(row, 4, product.SPEC_EN);
                        hot.setDataAtRowProp(row, 5, product.SPEC_VN);
                        hot.setDataAtRowProp(row, 6, product.hold_time);
                        hot.setDataAtRowProp(row, 8, product.consumption);
                    }
                });
            });
            }

            // Call the function to fetch data and initialize Handsontable
            loadProductData();
            function saveTable() {
                const tableData = hot.getData();
                fetch(`/api/save/{{ table.id }}/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify(tableData)
                })
                .then(response => response.json())
                .then(data => alert(data.message || data.error));
            }

            function saveTableWithTempName() {
                const tableData = hot.getData();
                
                fetch(`/api/save-with-temp-name/{{ table.id }}/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify(tableData)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Table saved with temp name successfully!');
                        window.location.href = `/edit/${data.new_table_id}/`;
                    } else {
                        alert(data.error || 'Failed to save table with temp name.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while saving the table.');
                });
            }

            function appendFooterRow() {
                const newRowIndex = hot.countRows(); // Get index for the new row
                hot.alter('insert_row', newRowIndex); // Insert a new row

                // Set text for merged cells
                hot.setDataAtRowProp(newRowIndex, 0, "PREPARED BY : FINISHING SPECIALIST");
                hot.setDataAtRowProp(newRowIndex, 4, "APPROVED BY: PAINT SUPPLIER");
                hot.setDataAtRowProp(newRowIndex, 14, "APPROVED BY: FINISHING MANAGER");

                // Get current merged cells
                let existingMerges = hot.getSettings().mergeCells || [];

                // Add new row merge settings without removing previous ones
                existingMerges.push(
                    { row: newRowIndex, col: 0, rowspan: 1, colspan: 4 },  // Merge col 0-3
                    { row: newRowIndex, col: 4, rowspan: 1, colspan: 10 }, // Merge col 4-13
                    { row: newRowIndex, col: 14, rowspan: 1, colspan: 4 }  // Merge col 14-17
                );

                // Update Handsontable settings with the merged list
                hot.updateSettings({ mergeCells: existingMerges });

                // Apply class for styling
                for (let col = 0; col < 18; col++) {
                    hot.setCellMeta(newRowIndex, col, 'className', 'htLastRow');
                }

                hot.render(); // Re-render the table
            }


            function captureTable() {
    const tableElement = document.getElementById('print');
    
    // 1. Store original styles
    const originalStyles = {
        overflow: tableElement.style.overflow,
        paddingBottom: tableElement.style.paddingBottom
    };

    // 2. Force-show all content (critical for borders)
    tableElement.style.overflow = "visible";
    tableElement.style.paddingBottom = "1px"; // Forces bottom border render

    // 3. Target Handsontable's main containers
    const hotContainers = tableElement.querySelectorAll('.ht_master, .wtHolder');
    hotContainers.forEach(container => {
        container.style.overflow = "visible";
    });

    domtoimage.toPng(tableElement, {
        quality: 2,
        bgcolor: "white",
        style: {
            "box-sizing": "border-box", // Ensures borders are included
            "margin-bottom": "0"        // Prevents cutoff
        }
    }).then(dataUrl => {
        // 4. Restore original styles
        tableElement.style.overflow = originalStyles.overflow;
        tableElement.style.paddingBottom = originalStyles.paddingBottom;
        hotContainers.forEach(container => {
            container.style.overflow = "";
        });

        // 5. Create print preview with border protection
        const newWindow = window.open("");
        newWindow.document.write(`
            <html>
                <head>
                    <style>
                        body { 
                            margin: 0;
                            padding: 10px; /* Safe area for borders */
                        }
                        img { 
                            max-width: 100%;
                            display: block; /* Removes line-height space */
                            border: 1px solid transparent; /* Fallback */
                        }
                    </style>
                </head>
                <body>
                    <img src="${dataUrl}">
                </body>
            </html>
        `);
        newWindow.document.close();
    }).catch(error => console.error("Capture failed:", error));
};


        </script>
    <!-- JavaScript -->
    <script src="{% static 'hot_table.js' %}"></script>
    </body>
</html>
